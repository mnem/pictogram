//
//  PGProgramCompiler.c
//
//  Created by David Wagner on 05/07/2012.
//  Copyright (c) 2012 Noise & Heat. All rights reserved.
//

#include <stdlib.h>
#include "CUnit/Basic.h"
#include "../TestHelpers.h"
#include "Pictogram.h"

const char test_01_fsh[];
const char test_01_vsh[];

static void test_create_fragment_shader_from_file(void)
{
	GLuint shader = 0;
	const char testFile[] = "test_01.fsh";
	char *path = pgMallocTestAssetPath(testFile);
	char *log = NULL;
	
	PGResult result = pgCompileShaderFile(&shader, GL_FRAGMENT_SHADER, path, &log);
	
	CU_ASSERT_EQUAL(result, PGR_OK);
	CU_ASSERT_NOT_EQUAL(shader, 0);
	CU_ASSERT_NOT_EQUAL(log, NULL);
	
	glDeleteShader(shader);
	free(path);
	free(log);
}

static void test_create_fragment_shader_from_string(void)
{
	GLuint shader = 0;
	char *log = NULL;
	
	PGResult result = pgCompileShaderString(&shader, GL_FRAGMENT_SHADER, test_01_fsh, &log);
	
	CU_ASSERT_EQUAL(result, PGR_OK);
	CU_ASSERT_NOT_EQUAL(shader, 0);
	CU_ASSERT_NOT_EQUAL(log, NULL);
	
	glDeleteShader(shader);
	free(log);
}

static void test_create_vertex_shader_from_file(void)
{
	GLuint shader = 0;
	const char testFile[] = "test_01.vsh";
	char *path = pgMallocTestAssetPath(testFile);
	char *log = NULL;
	
	PGResult result = pgCompileShaderFile(&shader, GL_VERTEX_SHADER, path, &log);
	
	CU_ASSERT_EQUAL(result, PGR_OK);
	CU_ASSERT_NOT_EQUAL(shader, 0);
	CU_ASSERT_NOT_EQUAL(log, NULL);
	
	glDeleteShader(shader);
	free(path);
	free(log);
}

static void test_create_vertex_shader_from_string(void)
{
	GLuint shader = 0;
	char *log = NULL;
	
	PGResult result = pgCompileShaderString(&shader, GL_VERTEX_SHADER, test_01_vsh, &log);
	
	CU_ASSERT_EQUAL(result, PGR_OK);
	CU_ASSERT_NOT_EQUAL(shader, 0);
	CU_ASSERT_NOT_EQUAL(log, NULL);
	
	glDeleteShader(shader);
	free(log);
}

static void test_create_new_program_with_no_shaders(void)
{
	GLuint program = 0;
	char *log = NULL;
	
	PGResult result = pgCreateAndLinkProgram(&program, 0, 0, &log);
	
	CU_ASSERT_EQUAL(result, PGR_CouldNotLinkProgram);
	CU_ASSERT_EQUAL(program, 0);
	CU_ASSERT_NOT_EQUAL(log, NULL);
	
	free(log);
}

static void test_create_new_program_with_one_vertex_shader(void)
{
	// Shader setup
	GLuint shader = 0;
	PGResult result = pgCompileShaderString(&shader, GL_VERTEX_SHADER, test_01_vsh, NULL);
	CU_ASSERT_EQUAL(result, PGR_OK);

	// Program
	GLuint program = 0;
	char *log = NULL;
	
	result = pgCreateAndLinkProgram(&program, shader, 0, &log);
	
	CU_ASSERT_EQUAL(result, PGR_CouldNotLinkProgram);
	CU_ASSERT_EQUAL(program, 0);
	CU_ASSERT_NOT_EQUAL(log, NULL);
	
	glDeleteShader(shader);
	free(log);
}

static void test_create_new_program_with_one_fragment_shader(void)
{
	// Shader setup
	GLuint shader = 0;
	PGResult result = pgCompileShaderString(&shader, GL_FRAGMENT_SHADER, test_01_fsh, NULL);
	CU_ASSERT_EQUAL(result, PGR_OK);
	
	// Program
	GLuint program = 0;
	char *log = NULL;
	
	result = pgCreateAndLinkProgram(&program, 0, shader, &log);
	
	CU_ASSERT_EQUAL(result, PGR_CouldNotLinkProgram);
	CU_ASSERT_EQUAL(program, 0);
	CU_ASSERT_NOT_EQUAL(log, NULL);
	
	glDeleteShader(shader);
	free(log);
}

static void test_create_new_program_with_one_vertex_shader_and_one_fragment_shader(void)
{
	// Shader setup
	GLuint vsh = 0;
	PGResult result = pgCompileShaderString(&vsh, GL_VERTEX_SHADER, test_01_vsh, NULL);
	CU_ASSERT_EQUAL(result, PGR_OK);
	GLuint fsh = 0;
	result = pgCompileShaderString(&fsh, GL_FRAGMENT_SHADER, test_01_fsh, NULL);
	CU_ASSERT_EQUAL(result, PGR_OK);
	
	// Program
	GLuint program = 0;
	char *log = NULL;
	
	result = pgCreateAndLinkProgram(&program, vsh, fsh, &log);
	
	CU_ASSERT_EQUAL(result, PGR_OK);
	CU_ASSERT_NOT_EQUAL(program, 0);
	CU_ASSERT_NOT_EQUAL(log, NULL);
	
	glDeleteShader(vsh);
	glDeleteShader(fsh);
	glDeleteProgram(program);
	free(log);
}

CU_pSuite PGProgramCompilerTestSetup(void)
{
	CREATE_SUITE("Program Compiler", NULL, NULL);
	
	if(!suite ||
	   !ADD_TEST(suite, test_create_fragment_shader_from_file) ||
	   !ADD_TEST(suite, test_create_fragment_shader_from_string) ||
	   !ADD_TEST(suite, test_create_vertex_shader_from_file) ||
	   !ADD_TEST(suite, test_create_vertex_shader_from_string) ||
	   !ADD_TEST(suite, test_create_new_program_with_no_shaders) ||
	   !ADD_TEST(suite, test_create_new_program_with_one_vertex_shader) ||
	   !ADD_TEST(suite, test_create_new_program_with_one_fragment_shader) ||
	   !ADD_TEST(suite, test_create_new_program_with_one_vertex_shader_and_one_fragment_shader) 
	   )
	{
		return NULL;
	}
	
	return suite;
}

const char test_01_fsh[] = {
	0x2f, 0x2f, 0x0a, 0x2f, 0x2f, 0x20, 0x20, 0x74, 0x65, 0x73, 0x74, 0x5f,
	0x30, 0x31, 0x2e, 0x66, 0x73, 0x68, 0x0a, 0x2f, 0x2f, 0x0a, 0x2f, 0x2f,
	0x20, 0x20, 0x43, 0x72, 0x65, 0x61, 0x74, 0x65, 0x64, 0x20, 0x62, 0x79,
	0x20, 0x44, 0x61, 0x76, 0x69, 0x64, 0x20, 0x57, 0x61, 0x67, 0x6e, 0x65,
	0x72, 0x20, 0x6f, 0x6e, 0x20, 0x30, 0x31, 0x2f, 0x30, 0x37, 0x2f, 0x32,
	0x30, 0x31, 0x32, 0x2e, 0x0a, 0x2f, 0x2f, 0x20, 0x20, 0x43, 0x6f, 0x70,
	0x79, 0x72, 0x69, 0x67, 0x68, 0x74, 0x20, 0x28, 0x63, 0x29, 0x20, 0x32,
	0x30, 0x31, 0x32, 0x20, 0x4e, 0x6f, 0x69, 0x73, 0x65, 0x20, 0x26, 0x20,
	0x48, 0x65, 0x61, 0x74, 0x2e, 0x20, 0x41, 0x6c, 0x6c, 0x20, 0x72, 0x69,
	0x67, 0x68, 0x74, 0x73, 0x20, 0x72, 0x65, 0x73, 0x65, 0x72, 0x76, 0x65,
	0x64, 0x2e, 0x0a, 0x2f, 0x2f, 0x0a, 0x0a, 0x76, 0x61, 0x72, 0x79, 0x69,
	0x6e, 0x67, 0x20, 0x6c, 0x6f, 0x77, 0x70, 0x20, 0x76, 0x65, 0x63, 0x34,
	0x20, 0x63, 0x6f, 0x6c, 0x6f, 0x72, 0x56, 0x61, 0x72, 0x79, 0x69, 0x6e,
	0x67, 0x3b, 0x0a, 0x0a, 0x76, 0x6f, 0x69, 0x64, 0x20, 0x6d, 0x61, 0x69,
	0x6e, 0x28, 0x29, 0x0a, 0x7b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x67, 0x6c,
	0x5f, 0x46, 0x72, 0x61, 0x67, 0x43, 0x6f, 0x6c, 0x6f, 0x72, 0x20, 0x3d,
	0x20, 0x63, 0x6f, 0x6c, 0x6f, 0x72, 0x56, 0x61, 0x72, 0x79, 0x69, 0x6e,
	0x67, 0x3b, 0x0a, 0x7d, 0x0a, 0x00
};

const char test_01_vsh[] = {
	0x2f, 0x2f, 0x0a, 0x2f, 0x2f, 0x20, 0x20, 0x74, 0x65, 0x73, 0x74, 0x5f,
	0x30, 0x31, 0x2e, 0x76, 0x73, 0x68, 0x0a, 0x2f, 0x2f, 0x0a, 0x2f, 0x2f,
	0x20, 0x20, 0x43, 0x72, 0x65, 0x61, 0x74, 0x65, 0x64, 0x20, 0x62, 0x79,
	0x20, 0x44, 0x61, 0x76, 0x69, 0x64, 0x20, 0x57, 0x61, 0x67, 0x6e, 0x65,
	0x72, 0x20, 0x6f, 0x6e, 0x20, 0x30, 0x31, 0x2f, 0x30, 0x37, 0x2f, 0x32,
	0x30, 0x31, 0x32, 0x2e, 0x0a, 0x2f, 0x2f, 0x20, 0x20, 0x43, 0x6f, 0x70,
	0x79, 0x72, 0x69, 0x67, 0x68, 0x74, 0x20, 0x28, 0x63, 0x29, 0x20, 0x32,
	0x30, 0x31, 0x32, 0x20, 0x4e, 0x6f, 0x69, 0x73, 0x65, 0x20, 0x26, 0x20,
	0x48, 0x65, 0x61, 0x74, 0x2e, 0x20, 0x41, 0x6c, 0x6c, 0x20, 0x72, 0x69,
	0x67, 0x68, 0x74, 0x73, 0x20, 0x72, 0x65, 0x73, 0x65, 0x72, 0x76, 0x65,
	0x64, 0x2e, 0x0a, 0x2f, 0x2f, 0x0a, 0x0a, 0x61, 0x74, 0x74, 0x72, 0x69,
	0x62, 0x75, 0x74, 0x65, 0x20, 0x76, 0x65, 0x63, 0x34, 0x20, 0x70, 0x6f,
	0x73, 0x69, 0x74, 0x69, 0x6f, 0x6e, 0x3b, 0x61, 0x74, 0x74, 0x72, 0x69,
	0x62, 0x75, 0x74, 0x65, 0x20, 0x76, 0x65, 0x63, 0x33, 0x20, 0x6e, 0x6f,
	0x72, 0x6d, 0x61, 0x6c, 0x3b, 0x76, 0x61, 0x72, 0x79, 0x69, 0x6e, 0x67,
	0x20, 0x6c, 0x6f, 0x77, 0x70, 0x20, 0x76, 0x65, 0x63, 0x34, 0x20, 0x63,
	0x6f, 0x6c, 0x6f, 0x72, 0x56, 0x61, 0x72, 0x79, 0x69, 0x6e, 0x67, 0x3b,
	0x75, 0x6e, 0x69, 0x66, 0x6f, 0x72, 0x6d, 0x20, 0x6d, 0x61, 0x74, 0x34,
	0x20, 0x6d, 0x6f, 0x64, 0x65, 0x6c, 0x56, 0x69, 0x65, 0x77, 0x50, 0x72,
	0x6f, 0x6a, 0x65, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x4d, 0x61, 0x74, 0x72,
	0x69, 0x78, 0x3b, 0x0a, 0x75, 0x6e, 0x69, 0x66, 0x6f, 0x72, 0x6d, 0x20,
	0x6d, 0x61, 0x74, 0x33, 0x20, 0x6e, 0x6f, 0x72, 0x6d, 0x61, 0x6c, 0x4d,
	0x61, 0x74, 0x72, 0x69, 0x78, 0x3b, 0x0a, 0x0a, 0x76, 0x6f, 0x69, 0x64,
	0x20, 0x6d, 0x61, 0x69, 0x6e, 0x28, 0x29, 0x0a, 0x7b, 0x0a, 0x20, 0x20,
	0x20, 0x20, 0x76, 0x65, 0x63, 0x33, 0x20, 0x65, 0x79, 0x65, 0x4e, 0x6f,
	0x72, 0x6d, 0x61, 0x6c, 0x20, 0x3d, 0x20, 0x6e, 0x6f, 0x72, 0x6d, 0x61,
	0x6c, 0x69, 0x7a, 0x65, 0x28, 0x6e, 0x6f, 0x72, 0x6d, 0x61, 0x6c, 0x4d,
	0x61, 0x74, 0x72, 0x69, 0x78, 0x20, 0x2a, 0x20, 0x6e, 0x6f, 0x72, 0x6d,
	0x61, 0x6c, 0x29, 0x3b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x76, 0x65, 0x63,
	0x33, 0x20, 0x6c, 0x69, 0x67, 0x68, 0x74, 0x50, 0x6f, 0x73, 0x69, 0x74,
	0x69, 0x6f, 0x6e, 0x20, 0x3d, 0x20, 0x76, 0x65, 0x63, 0x33, 0x28, 0x30,
	0x2e, 0x30, 0x2c, 0x20, 0x30, 0x2e, 0x30, 0x2c, 0x20, 0x31, 0x2e, 0x30,
	0x29, 0x3b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x76, 0x65, 0x63, 0x34, 0x20,
	0x64, 0x69, 0x66, 0x66, 0x75, 0x73, 0x65, 0x43, 0x6f, 0x6c, 0x6f, 0x72,
	0x20, 0x3d, 0x20, 0x76, 0x65, 0x63, 0x34, 0x28, 0x30, 0x2e, 0x34, 0x2c,
	0x20, 0x30, 0x2e, 0x34, 0x2c, 0x20, 0x31, 0x2e, 0x30, 0x2c, 0x20, 0x31,
	0x2e, 0x30, 0x29, 0x3b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x0a, 0x20, 0x20,
	0x20, 0x20, 0x66, 0x6c, 0x6f, 0x61, 0x74, 0x20, 0x6e, 0x44, 0x6f, 0x74,
	0x56, 0x50, 0x20, 0x3d, 0x20, 0x6d, 0x61, 0x78, 0x28, 0x30, 0x2e, 0x30,
	0x2c, 0x20, 0x64, 0x6f, 0x74, 0x28, 0x65, 0x79, 0x65, 0x4e, 0x6f, 0x72,
	0x6d, 0x61, 0x6c, 0x2c, 0x20, 0x6e, 0x6f, 0x72, 0x6d, 0x61, 0x6c, 0x69,
	0x7a, 0x65, 0x28, 0x6c, 0x69, 0x67, 0x68, 0x74, 0x50, 0x6f, 0x73, 0x69,
	0x74, 0x69, 0x6f, 0x6e, 0x29, 0x29, 0x29, 0x3b, 0x0a, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x63, 0x6f, 0x6c, 0x6f, 0x72,
	0x56, 0x61, 0x72, 0x79, 0x69, 0x6e, 0x67, 0x20, 0x3d, 0x20, 0x64, 0x69,
	0x66, 0x66, 0x75, 0x73, 0x65, 0x43, 0x6f, 0x6c, 0x6f, 0x72, 0x20, 0x2a,
	0x20, 0x6e, 0x44, 0x6f, 0x74, 0x56, 0x50, 0x3b, 0x0a, 0x20, 0x20, 0x20,
	0x20, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x67, 0x6c, 0x5f, 0x50, 0x6f, 0x73,
	0x69, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x3d, 0x20, 0x6d, 0x6f, 0x64, 0x65,
	0x6c, 0x56, 0x69, 0x65, 0x77, 0x50, 0x72, 0x6f, 0x6a, 0x65, 0x63, 0x74,
	0x69, 0x6f, 0x6e, 0x4d, 0x61, 0x74, 0x72, 0x69, 0x78, 0x20, 0x2a, 0x20,
	0x70, 0x6f, 0x73, 0x69, 0x74, 0x69, 0x6f, 0x6e, 0x3b, 0x0a, 0x7d, 0x0a, 0x00
};
